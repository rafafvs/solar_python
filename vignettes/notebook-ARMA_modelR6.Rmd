---
title: "ARMA_modelR6"
author: "Beniamino Sartini"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, warning=FALSE, message=FALSE}
library(solarr)
set.seed(2)
# Simulate a time series 
u <- rnorm(1000, 0, 1)
x <- u[1]
for(i in 1:length(u)){
  x[i+1] <- 0.8 * x[i] + u[i]
}
```

## ARMA functions

Build a companion matrix 

```{r}
phi <- c(0.5)
theta <- c(0.4)
# Only AR
ARMA_companion_matrix(phi)
ARMA_companion_matrix(rep(phi, 4))
# Only MA
ARMA_companion_matrix(theta)
ARMA_companion_matrix(rep(theta, 4))
# ARMA
ARMA_companion_matrix(c(0.4, 0.2), c(0.3))
ARMA_companion_matrix(c(0.1, 0.02, 0.01), c(0.3, 0.1, 0.05))
```

Build the vector b

```{r}
# ARMA(2,2)
ARMA_vector_b(2,2)
# AR(2)
ARMA_vector_b(2,0)
# MA(2)
ARMA_vector_b(0,2)
```

Expectation of an ARMA 

```{r}
A <- ARMA_companion_matrix(c(0.4, 0.1), c(0.1, 0.05))
b <- ARMA_vector_b(2,2)
intercept <- 0.2
X0 <- c(0.9, 0.2, -0.1, 0.3)
# 1 step ahead
ARMA_expectation(h = 1, X0, A, b, intercept)
# 5 steps aheds
ARMA_expectation(h = 5, X0, A, b, intercept)
# 100 steps ahead
ARMA_expectation(h = 100, X0, A, b, intercept)
```

ARMA variance
```{r}
A <- ARMA_companion_matrix(c(0.4, 0.1), c(0.1, 0.05))
b <- ARMA_vector_b(2,2)
# 1 step ahead
ARMA_variance(h = 1, A, b, sigma2 = 1)
# 5 step ahead
ARMA_variance(h = 5, A, b, sigma2 = 1)
# 100 step ahead
ARMA_variance(h = 100, A, b, sigma2 = 1)
```
AR variance
```{r}
# AR (1)
phi <- 0.4
ARMA_variance(1000, ARMA_companion_matrix(phi), ARMA_vector_b(1, 0))
AR_variance(phi, 1)
# AR (2)
phi <- c(phi, 0.1)
ARMA_variance(1000, ARMA_companion_matrix(phi), ARMA_vector_b(2, 0))
AR_variance(phi, 1)
# AR (3)
phi <- c(phi, 0.05)
ARMA_variance(1000, ARMA_companion_matrix(phi), ARMA_vector_b(3, 0))
AR_variance(phi, 1)
# AR (4) (no good)
phi <- c(phi, 0.03)
ARMA_variance(10000, ARMA_companion_matrix(phi), ARMA_vector_b(4, 0))
AR_variance(phi, 1)
```
ARMA covariances
```{r}
# 1 step ahead
ARMA_covariance(h = 1, 2, A, b, sigma2 = 1)
# 5 step ahead
ARMA_covariance(h = 5, 10, A, b, sigma2 = 1)
# 100 step ahead
ARMA_covariance(h = 100, 2, A, b, sigma2 = 1)
```




## Initialization 

- `arOrder`: Autoregressive order. 
- `maOrder`: Moving Average order. 
- `include.intercept`: Include or not the intercept, by default is `FALSE`. 

```{r}
# Initialize the model without intercept
arma <- ARMA_modelR6$new(arOrder = 1, maOrder = 2, include.intercept = FALSE)
```

## Fit 

Fit the model
```{r}
arma$fit(x)
# Function check
# self <- arma$.__enclos_env__$self
# private <- arma$.__enclos_env__$private
```


```{r, echo=FALSE, results='asis'}
library(fansi)
# Run your colored output function, capturing the console text
txt <- capture.output(arma)
# Convert ANSI color codes (\[1;31m etc.) to HTML <span> styles
html_txt <- fansi::sgr_to_html(txt)
# Print as HTML so it renders properly
cat(html_txt, sep = "<br>\n")
```

Extract ARMA model
```{r}
arma$model
```
All the estimated parameters: 
```{r}
arma$coefficients
```
MA coefficients only
```{r}
arma$theta
```
AR coefficients only
```{r}
arma$phi
```
Companion matrix is computed with the function `ARMA_companion_matrix()`
```{r}
arma$A
```
Tidy parameters
```{r}
arma$tidy
```

## Next step 

Next step forecast with the function  `ARMA_next_step()`
```{r}
X0 <- c(Y_lag1 = 0.4, eps_lag1 = -0.03, eps_lag2 = 0.2)
# Manual next step
X1 <- sum(arma$phi * X0[1]) + sum(arma$theta * X0[2:3])
X1 <- matrix(c(X1,  0, X0[2]), ncol = 1)
X1
arma$next_step(X0, n.ahead = 1, eps = 0)
```
Two steps ahead forecast: 
```{r}
# Manual next step
X2 <- sum(arma$phi * X1[1]) + sum(arma$theta * X1[2:3])
X2 <- matrix(c(X2,  0, 0), ncol = 1)
X2
# ARMA model
#arma$next_step(X0, n.ahead = 2, eps = 0)
```

Next step simulation: 
```{r}
# Simulated residuals 
eps0 <- rnorm(1)
# Manual next step simulation 
X1 <- sum(arma$phi * X0[1]) + sum(arma$theta * X0[2:3]) + eps0
X1 <- matrix(c(X1,  eps0, X0[2]), ncol = 1)
X1
arma$next_step(X0, n.ahead = 1, eps = eps0)
```

## Moments

```{r}
# Create new coefficients
arma$mean
```

```{r}
# Create new coefficients
arma$variance
```

## Update parameters

```{r}
# Create new coefficients
coefficients <- arma$coefficients
coefficients <- coefficients*runif(length(coefficients), 0.7, 1.3)
coefficients
```

```{r}
# Update the parameters
arma$update(coefficients)
# Update the parameters
std.errors <- coefficients*0.01
arma$update_std.errors(std.errors)
```

```{r, echo=FALSE, results='asis'}
library(fansi)
# Run your colored output function, capturing the console text
txt <- capture.output(arma)
# Convert ANSI color codes (\[1;31m etc.) to HTML <span> styles
html_txt <- fansi::sgr_to_html(txt)
# Print as HTML so it renders properly
cat(html_txt, sep = "<br>\n")
```


